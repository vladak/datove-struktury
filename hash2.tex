% Souèást skript na Datové struktury. Viz main.tex
\markright{$ $Id$ $}

\chapter{Ha¹ování II}

% --------------------------------------------------------------------------
\section{Univerzální ha¹ování}

Idea univerzálního ha¹ovaní má odstranit po¾adavek na rovnomìrné 
rozlo¾ení vstupních dat. Tento po¾adavek chceme nahradit tím, ¾e 
budeme mít soubor $H$ ha¹ovacích funkcí do tabulky velikosti $m$ takový,
¾e pro ka¾dou podmno¾inu $S$ univerza $U$ je pravdìpodobnost, ¾e funkce z 
$H$ se chová dobøe, hodnì velká (tj. je jen málo kolizí). V tomto pøípadì, 
kdy¾ vybereme $h$ z $H$ náhodnì s rovnomìrným rozlo¾ením, pak pro ka¾dou 
podmno¾inu $S\subseteq U$ takovou, ¾e $|S|\leq m$, bude oèekávaný èas 
(poèítaný pøes v¹echny funkce z $H$) konstantní. Rozdíl proti tradiènímu 
ha¹ovaní je, ¾e pøedpoklad rovnomìrného výbìru ha¹ovací funkce z mno¾iny 
$H$ mù¾eme zajistit (nebo se k splnìní tohoto po¾adavku pøiblí¾it), ale 
výbìr vstupních dat ovlivnit nemù¾eme. Nyní tuto ideu zformalizujeme. 
\mnote{zajímá nás jednak $c$, jednak velikost systému}

\begin{defn}
\label{c-us}
Tøída ha¹ovacích funkcí 
\( H \subseteq \{h | h: \intrange{0}{N-1} \rightarrow \intrange{0}{m-1}\} \)
je \emph{c-univerzální}, kde $c\in\mathbb{R}^+$, jestli¾e 
\begin{equation*}
\forall x\neq y\in \intrange{0}{N-1} :
\left |\{h\in H : h(x)=h(y)\}\right| \leq c\frac{|H|}{m}, 
\end{equation*}
\end{defn}

%Dolní mez pro $c$, dk na cvièení.
% rádi bychom \( c \) co nejmen¹í, ale dá se dokázat,
% ¾e neexistují \( c \)-univerzální tøídy pro
% \( c<1-\frac{m}{N} \).

% ..........................................................................

Nejprve uká¾eme, ¾e $c$-univerzální systémy existují. 
Pøedpokládáme, ¾e $U = \intrange{0}{N-1}$, kde $N$ je prvoèíslo.
Definujme 
\[ H=\{h_{ab}:h_{ab}(x)=((ax+b)\bmod N)\bmod m;
\ a,b\in \intrange{0}{N-1}\} \]
\begin{theorem}
$H$ je \( c \)-univerzální a 
\( c=\left( \left\lceil \frac{N}{m}\right\rceil /\frac{N}{m}\right) ^{2} \).
\end{theorem}
\begin{proof}
\( |H|=N^{2} \), co¾ je poèet dvojic $(a,b)$.

Nech» $(x,y)$ jsou libovolné, ale pevné.
Kolize nastane v pøípadech, kdy¾:

\[
h_{ab}(x)=h_{ab}(y),\]
neboli
\begin{eqnarray*}
ax+b & = & q+rm\pmod N\\
ay+b & = & q+sm\pmod N
\end{eqnarray*}

kde $(a,b)$ jsou neznámé a parametry $(q,r,s)$ nabývají v¹ech
hodnot takových, ¾e
\[
q\in \intrange{0}{m-1}
\land r,s\in \intrange{0}{\left\lceil N/m\right\rceil -1}.
\]


$N$ je prvoèíslo, tedy $\mathbb{Z}_N$ je tìleso a pro ka¾dou trojici parametrù
$(q,r,s)$ má soustava právì jedno øe¹ení $(a,b)$. 
Poèet kolidujících funkcí je pøesnì tolik, jako poèet trojic
$(q,r,s)$, který je
\( m\cdot \left\lceil N/m\right\rceil ^{2} \).

\( 
\left| \left\{ h_{ab}:h_{ab}(x)=h_{ab}(y)\right\} \right| 
\leq m\left\lceil \frac{N}{m}\right\rceil ^2
=\frac{\left\lceil \frac{N}{m}\right\rceil ^{2}}{\left(\frac{N}{m}\right) ^{2}}\frac{N^{2}}{m}
=c\frac{|H|}{m}
\)
\mnote{$m$ je poèet $q$, $\left\lceil \frac{N}{m}\right\rceil ^{2}$ je
poèet $q,s$}

$\Rightarrow$ tento univerzální systém lze zkonstruovat. Velikost $H$ je
$N^2$.
\end{proof}

% ..........................................................................

\subsection{Oèekávaná délka øetìzce}

\begin{defn}
Mìjme libovolnou pevnou $S \subseteq U$, libovolné pevné $x \in
U$ a funkci $h: U \to \intrange{0}{m-1}$. Definujme
\begin{equation}
S_{h,x}= \text{øetìzec prvkù $y \in S$, pro které platí $h(y) = h(x)$}.
\end{equation}

Zaveïme
\mnote{Iversonova konvence: [true]=1, [false]=0}
\begin{align}
\delta_h(x,y) & = [ x \neq y \land h(x) = h(y) ]\\
\delta_h(x,S) & = \sum_{y \in S} \delta_h(x,y),
\end{align}
\end{defn}

Chceme spoèítat prùmìrnou délku $S_x$, kde prùmìr poèítáme pøes
v¹echny $h \in H$, kde $H$ je $c$-univerzální systém.

\begin{theorem}
Kdy¾ H je c-universální systém, pak $\forall S \subseteq U$ a $\forall x \in
U$ je oèekávaná hodnota \\
\[
\delta_h(x,y) = 
\begin{cases}
\frac{c(|S| - 1)}{m} & x \in S \\
\frac{c|S|}{m} & x \notin S
\end{cases}
\]
\\
, kde prùmìr se bere pøes $h \in H$ a pøedpokládáme rovnomìrný výbìr fcí z
$H$.
\end{theorem}

\begin{proof}
\begin{equation*}
\begin{split}
\sum_{h \in H} \delta_h(x, S)
 & = \sum_{h \in H} \sum_{\substack{y \in S\\y \ne x}} \delta_h(x,y)
   = \sum_{\substack{y \in S\\y \ne x}} \sum_{h \in H} \delta_h(x,y)\\
 & = \sum_{\substack{y \in S\\y \ne x}} |\{ h \in H; h(x) = h(y) \}|
   \leq \sum_{\substack{y \in S\\y \ne x}} \frac{c|H|}m \\
 & = \begin{cases}
 \frac{cn|H|}m & x \notin S \\
 \frac{c(n-1)|H|}m & x \in S \\
 \end{cases}
\end{split}
\end{equation*}
Tedy  prùmìrná hodnota $\delta_h(x,S) \leq \frac{cn}m$.
\end{proof}

\begin{theorem}
\label{veta-ocek-pocet}
Pro ka¾dou mno¾inu $S \subseteq U$, $|S| = n$ a ka¾dé $x$ je oèekávaný
èas operací MEMBER, INSERT, DELETE $O(c \cdot n/m)$, pøièem¾ je braný
pøes v¹echny funkce $h \in H$ pøi jejich rovnomìrném rozdìlení.
\end{theorem}

\begin{theorem}
Markovova nerovnost: $\pr(X \geq t \mathrm{E}X) \leq 1/t$
\end{theorem}

\begin{pozn}
Jiná formulace Markovovy nerovnosti (vìty) mù¾e být tato: \\
Kdy¾ $X$ je náhodná velièina s oèekávanou hodnoutou $\mu$, pak 
$P(X \geq t \mu) \leq \frac{1}{t}$.
\end{pozn}

\begin{proof}                                                                   
X je rovnomìrnì rozdìlená náhodná velièina nabývající hodnot $\{x_i : i
\in     
I \}$, $I \subset \Bbb N$,                                                      
$I' = \{ i \in I : x_i \geq t \mu \}$, pak                                      
\begin{align*}                                                                  
\mu                                                                             
&= \frac 1{|I|} \sum_{i \in I} x_i                                              
    && I' \subset I\\                                                           
& > \frac 1{|I|} \sum_{i \in I'} x_i                                            
    && \text{z definice } I'\\                                                  
& \geq \frac 1{|I|} \sum_{i \in I'} t \mu\\                                     
& = \frac {|I'|}{|I|} t \mu                                                     
\end{align*}                                                                    
a tedy                                                                          
\[                                                                              
\pr(X \geq t \mu) =  \frac {|I'|}{|I|} < \frac 1t                               
\]                                                                              
\end{proof}

Varianta Markovovy nerovnosti:
\begin{theorem}
Za stejných pøedpokladù jako u 
% pøedchozí 
vìty \ref{veta-ocek-pocet}, kdy¾ $\mu$ je prùmìrná
délka øetìzce $S_{h,x}$, pak 
\[
\forall t > 1\ 
 \pr(|S_{h,x}| \geq t \mu)
 < \frac 1t
\]
\end{theorem}

\begin{proof}
plyne z Markovovy nerovnosti.

%
% tohle je nejaky puvodni dukaz. (V. Kotal)
%
%H je $c$-univerzální systém. Nech» 
%$H' = \{ h \in H; |S_{h,x}| \geq t \mu \}$. 
%\begin{align*}
%\mu  
%&= \frac 1{|H|} \sum_{h \in H} |S_{h,x}|
%	&& H' \subset H\\
%& > \frac 1{|H|} \sum_{h \in H'} |S_{h,x}|
%	&& \text{z definice } H'\\
%& \geq \frac 1{|H|} \sum_{h \in H'} t \mu\\
%& = \frac {|H'|}{|H|} t \mu
%\end{align*}
%a tedy
%\[
%\pr(|S_{h,x}| \geq t \mu) =  \frac {|H'|}{|H|} < \frac 1t
%\]
\end{proof}


% ..........................................................................
\subsection{Velikost $c$-univerzálního systému}

\subsubsection{Dolní mez}
Øekli jsme, ¾e pøi pou¾ití $c$-univerzálního systému z nìj ha¹ovací
funkce vybíráme náhodnì. V praxi ale budeme vìt¹inou pou¾ívat
pseudonáhodný generátor, který se po urèité periodì opakuje. Abychom 
zajistili co nejvìt¹í náhodnost,
potøebujeme, aby systém \( H \) mìl co nejménì funkcí.

\begin{theorem}
Kdy¾ $H$ je $c$-univerzální systém
funkcí z univerza $U$ do $\intrange{0}{m-1}$, pak 
\[ |H| \geq \frac{m}{c} \left\lceil (\log_m N) - 1 \right\rceil. \]
\end{theorem}
\begin{proof}
% Mìjme $c$-univerzální systém \( H = \{h_1 \ldots h_{|H|-1} \} \).
% h_{|H|-1} -> h_{|H|} by T.Matousek
Mìjme $c$-univerzální systém \( H = \{h_1 \ldots h_{|H|} \} \).
Nech» $U_0 = U$.

Nech» $U_1$ je nejvìt¹í podmno¾ina $U_0$ taková ¾e $h_1$ je na $(U_1)$
konstantní.

Nech» $U_2$ je nejvìt¹í podmno¾ina $U_1$ taková ¾e $h_2$ je na $(U_2)$
konstantní. (Také $h_1$ je na $(U_2)$ konstantní) A tak dále.

Platí
\begin{align*}
|U_0| & = N \\
|U_1| & \geq \left\lceil \frac Nm \right\rceil \\
|U_2| & \geq \left\lceil \frac {\left\lceil N/m \right\rceil}m \right\rceil 
	\geq^\dag \left\lceil \frac N{m^2} \right\rceil \\
|U_i| & \geq \left\lceil \frac N{m^i} \right\rceil \\
\end{align*}
\mnote{$^\dag$ vysvìtlit} 

Nech» $t =  \left\lceil \log_m N \right\rceil - 1$. 
Platí $\lceil x \rceil - 1 < x$ a $\log$ je rostoucí, tedy $m^t < N$ a 
\[
|U_t| \geq \left\lceil \frac N{m^t} \right\rceil > 1,
\]
neboli $U_t$ obsahuje alespoò 2 rùzné prvky, $a \ne b$

Nech» $* = |\{ h \in H : h(a) = h(b) \}|$. 
Z definice $c$-univerzálního systému $* \leq \frac {c|H|}m$. 
Proto¾e $h_1, \ldots, h_t$ jsou na $U_t$ konstantní, dostáváme $* \geq t$.
Zbytek je jednoduchý.
\end{proof}

Nás zajímá $\log_2 |H|$, tedy kolik bitù potøebujeme od
pseudonáhodného generátoru na urèení náhodné ha¹ovací funkce. Zjistili
jsme, ¾e potøebujeme nejménì
\( \log_2 m + \log_2 \lceil(\log_m N)-1\rceil -\log_2 c \) bitù.

%..........
\subsubsection{Pøíklad malého $c$-univerzálního systému}

My známe \( c \)-univerzální systém velikosti \( N^{2} \),
tedy \( \log _{2}|H|=2\log _{2}N \), co¾ je hodnì velké 
proti právì spoèítanému dolnímu odhadu. Nyní zkonstruujeme $c$-univerzální 
ha¹ovací systém, který tento dolní odhad v jistém smyslu nabývá.

Buï \( p_{1},p_{2}\ldots \) rostoucí posloupnost v¹ech prvoèísel. Z
teorie èísel bychom si mìli pamatovat, ¾e $p_t = O(t \log t)$.

Zvolíme nejmen¹í \( t \) takové, ¾e 
\begin{equation}
\label{deft}
t \ln p_{t}  \geq m \ln N
\end{equation}

Definujme
\begin{align}
h_{c,d,l}(x) &  = \left( c (x \bmod p_l) + d \right) \bmod p_{2t} \bmod m\\
H & = \{ h_{c,d,l} : c,d \in \intrange{0}{p_{2t}-1}, t < l \leq 2t \},
\end{align}

pak \( |H|=t p_{2t}^2 \), a tedy 
$\log_2 |H| = \log_2 t + 2 \log_2 p_{2t} 
= O( \log t + 2 \log 2t + 2 \log\log 2t)
= O(\log t)
= O(\log m + \log \log N)$, èím¾ jsme se dostali na dolní hranici
odvozenou vý¹e.

Doká¾eme, ¾e $H$ je 5-univerzální systém.

Zvolme \( x\neq y\in U\), spoèteme odhad 
\( |\{ h\in H : h_{c,d,l}(x) = h_{c,d,l}(y) \}|  \),
tedy musíme odhadnout ze shora poèet trojic $c, d, l$ takových, ¾e 
$h_{c,d,l}(x)=h_{c,d,l}(y)$.
Rozdìlíme je do dvou skupin:

\begin{enumerate}
\item $c,d,l$ taková, ¾e $h_{c,d,l}(x) = h_{c,d,l}(y)$,
ale $x \bmod p_l \neq y \bmod p_l$
\item $c,d,l$ taková, ¾e $h_{c,d,l}(x) = h_{c,d,l}(y)$,
a $x \bmod p_l = y \bmod p_l$
\end{enumerate}

\begin{enumerate}
\item
Platí
\begin{align*}
c (x \bmod p_l) + d & = k + qm  \pmod {p_{2t}}\\
c (y \bmod p_l) + d & = k + rm  \pmod {p_{2t}}
\end{align*}
pro nìjaká
\( 
k \in \intrange{0}{m-1},
q,r \in \intrange{0}{\lceil \frac{p_{2t}}{m}\rceil - 1}
\).
Proto¾e $p_l$ je prvoèíslo, je poèet trojic splòujících (1) roven
\begin{align*}
\text{poèet trojic} & \leq t m {\lceil \frac{p_{2t}}{m}\rceil}^2
	&& \#l \leq t, \# (c,d) = \# (k,q,r)  \\
& \leq t m {\left( 1 + \frac{p_{2t}}{m}\right)}^2\\
& = t m \frac{p_{2t}^2}{m^2} {\left( 1 + \frac m{p_{2t}} \right)}^2
	&& \text{vytknutím}\\
& = {\left( 1 + \frac m{p_{2t}} \right)}^2 \frac{|H|}m \\
& \leq 4 \frac{|H|}m
	&& \text{jestli¾e $m\leq p_{2t}$}
\end{align*}
Je¹tì tedy musíme ukázat, ¾e $m < p_{2t}$.
Kdyby ale $p_{2t} \leq m$, pak dostaneme tento spor:
$t \ln p_t < p_{2t} \ln p_{2t} \leq m \ln m \leq m \ln N 
\leq t \ln p_t$.

\begin{pozn}
$\forall (k,q,r) \exists! (c,d)$, které øe¹í rovnici, jeliko¾ 
$\Bbb Z_{p_{2t}}$ je tìleso a $x$ {\tt mod} $p_l \neq y$ {\tt mod} $p_l$.
\end{pozn}

\item
Nech» $L = \{ l : x \bmod p_l = y \bmod p_l \land t < l \leq 2t \}$. 
Pak poèet trojic splòujících (2) je roven  
\begin{align*}
\text{poèet trojic} & = |L| p_{2t}^2\\
& \leq \frac{t p_{2t}^2}m
	&& \text{jestli¾e $|L| \leq t/m$}\\
& = 1 \frac{|H|}m
\end{align*}

Pokud tedy je¹tì doká¾eme, ¾e $|L| \leq t/m$, pak 
\( 
|\{ h\in H : h_{c,d,l}(x) = h_{c,d,l}(y) \}|  
\leq 4 \frac{|H|}m + \frac{|H|}m = 5 \frac{|H|}m
\)
a H je 5-univerzální systém.
\end{enumerate}

Nech» $P = \prod_{l \in L} p_l$. 
Z definice $L$ v¹echna $p_l$ dìlí $|x-y|$, 
tedy i $P$ dìlí $|x-y|$, a proto $P \leq |x-y| \leq N$. Proto¾e
$P \geq p_t^{|L|}$, dostaneme $|L| \leq \ln N / \ln p_t$, a z definice
$t$ \eqref{deft} plyne $|L| \leq t/m$.

% ..........................................................................
\subsection{Reprezentace $S$ a operace MEMBER, INSERT, DELETE}

Máme $m$ a pro v¹echna $i = 0, 1, \ldots$ je dán $c_i$-univerzální
systém funkcí $H_i$ ha¹ující do tabulky velikosti $2^i
m$. Reprezentace $S \subseteq U$ :
\begin{itemize}
\item $|S|$ 
\item $i$ takové, ¾e $2^{i-2} m < |S| < 2^i m$ 
\item funkce $h \in H_i$ 
\item reprezentace $S$ vùèi $h_i$ 
\item $\forall j \in \{ 0 .. 2^i m -1\}$ je dána délka øetìzce
reprezentujícího prvky s $h(x)=j$ 
\item konstanty $d_i$ omezující délky øetìzce
\end{itemize}

\subsubsection{MEMBER}

MEMBER pracuje normálnì.

\subsubsection{INSERT}

viz algoritmus \ref{alg:hash2.univ.insert}

\begin{algorithm}[!htb]
\caption{INSERT pro universální ha¹ování}
\label{alg:hash2.univ.insert}
\begin{enumerate}
\item zjistíme, zda máme pøidat do $S$ 
\item kdy¾ délka $j$-tého øetìzce $+ 1 > d_i$,\\
 pak spoèítáme novou reprezentaci
\item kdy¾ $|S|+1 = 2^i m$,\\
 pak inkrementujeme $i$ a spoèítáme novou reprezentaci
\item jinak pøidáme prvek do øetìzce $h(x)$ 
\end{enumerate}
\end{algorithm}

\subsubsection{DELETE}

viz algoritmus \ref{alg:hash2.univ.delete}

\begin{algorithm}[!htb]
\caption{DELETE pro universální ha¹ování}
\label{alg:hash2.univ.delete}
\begin{enumerate}
\item zjistíme, zda $x \in S$ 
\item kdy¾ $x \in S$ a $|S|-1 = 2^{i-2} m$ a $i>0$,\\
 pak dekrementujeme $i$ a spoèítáme novou reprezentaci
\item jinak $x$ odstraníme z $h(x)$ 
\end{enumerate}
\end{algorithm}


\subsubsection{Spoèítání nové reprezentace}

\begin{algorithmic}
\REPEAT
  \STATE zvolíme náhodnì $h \in H_i$ 
  \STATE spoèítáme reprezentaci $S$ vùèi $h$ 
\UNTIL {v¹echny øetìzce mají délku $\leq d_i$}
\end{algorithmic}

Kolikrát probìhne ten cyklus? Závisí to na více parametrech 
% a Koubek to nikde uspokojivì spoèítané nevidìl.
a není jisté, zda to bylo nìkdy pøesnì spoèítáno.


% --------------------------------------------------------------------------
\section{Externí ha¹ování}

Máme dáno universum $U$ a vnìj¹í pamì»ové medium, které je rozdìleno do
stránek. Ka¾dá stránka mù¾e obsahovat nejvý¹e $b$ záznamù. Chceme navrhnout
ukládání prvkù do stránek tak, aby operace MEMBER, INSERT, DELETE
vy¾adovaly jen konstatní poèet pøístupù do externí pamìti, aby stránky
byly dostateènì zaplnìné. Tedy jinými slovy: chceme minimalizovat poèet
pøístupù do vnìj¹í pamìti.
\par
Vyhledáme v¾dy stránku ve vnìj¹í pamìti - natáhneme ji do vnitøní pamìti a
tam provedeme vyhledávání - toto vyhledávání nás ale nezajímá.
\par
Nech» $U$ je universum, $S \subseteq U$. Externí medium má stránky o
velikosti $b$. Je dána ha¹ovací funkce $h:U \rightarrow \{0,1\}^k$ prostá
(kódovací funkce), k libovolné. Funkce $h$ tedy generuje binární kódy délky
$k$.
\par
Vytvoøíme strom mno¾iny $S$. Vrcholy stromu jsou v¹echny prefixy slov $h(s),
s \in S$. Pro vrchol $\alpha$ jsou jeho synové $\alpha 0$ a $\alpha 1$
(pokud existují). Listy jsou prvky $h(s), s \in S$.

\begin{defn}
Pro $s \in S$ definujeme $\emph{d(s)} =$ délka nejkrat¹ího prefixu $\alpha$ 
slova $h(s)$, ¾e pod $\alpha$ je nejvý¹e $b$ listù.
\end{defn}

\begin{pozn}
Alternativní definice $d(s)$: $d(s) =$ délka nejkrat¹ího prefixu $h(s)$
taková, ¾e poèet prvkù $t \in S$, jejich¾ prefix délky $d(s)$ je stejný
jako prefix $h(s)$, je nejvý¹e $b$.
\end{pozn}

\begin{defn}
$d(S) = max\{d(s), s \in S\}$.
\end{defn}

\begin{priklad}
\label{priklad:exthash.tree}
Nech» $U = \{0,1\}^4, b = 2$ a
$S = \{ 0100, 0001, 0000, 1001 \}$

Tuto strukturu mù¾eme zobrazit do stromu, 
kde bude lépe viditelná hodnota $d(S)$.

\begin{figure}[!htb]
\centering\includegraphics{pics/exthash-tree}
\caption{Reprezentace mno¾iny $S$. Vrchol reprezentující prefix $0$, by ve
svém podstromì mìl 3 prvky, co¾ je více, ne¾ po¾adujeme pomocí hodnoty
$b$.}
\label{fig.hash.extern}
\end{figure}

Z obr. \ref{fig.hash.extern} plyne, ¾e hodnota $d(S) = 2$.
\end{priklad}

\begin{tvrzeni}
Platí: Kdy¾ $d(s) = k$ a prvek $t$ má stejný prefix délky $k$ jako $s$, 
pak $d(s) = d(t)$. 
\end{tvrzeni}

Reprezentace: 
\begin{itemize}
\item adresáø: ke ka¾dému slovu $\alpha$ délky $d(S)$ je pøiøazena adresa 
stránky, která obsahuje prvky $s \in S$, ¾e $h(s)$ má prefix $\alpha$.
Tato slova délky $d(s)$ jsou lexikograficky uspoøádána.
\item datová èást: stránky s pøiøazenými prvky
\end{itemize}

\begin{priklad}
Pøíklad adresáøe pro mno¾inu $\{0000, 0001, 0100, 1001 \}$:

\vspace{5mm}

\begin{tabular}{lll}
00 & $\rightarrow$ & 0000, 0001 \\
01 & $\rightarrow$ & 0100 \\
\hline
10 & $\searrow$ & \\
11 & $\rightarrow$ & 1001 \\
\end{tabular}
\end{priklad}

\begin{pozn}
Upøesnìní reprezentace stránky (stránek): \\
Prvek $s \in S$ je ulo¾en na stránce, která obsahuje v¹echny prvky $t \in
S$ takové, ¾e prefix $h(t)$ délky $d(s)$ bude je stejný jako $h(s)$, tato stánka
bude pøiøazena v¹em slovùm $\alpha$ délky $d(S)$ takovým, ¾e prefix $h(s)$ délky
$d(s)$ je prefix $\alpha$. \\
Pokud $\alpha$ neobsahuje ¾ádný takový prefix, tak je mu pøiøazena stránka
NIL.
\end{pozn}

\subsection{Operace ACCESS}

viz algoritmus \ref{alg:exthash.access}

\begin{algorithm}[!htb]
\caption{ACCESS pro externí ha¹ování}
\label{alg:exthash.access}
ACCESS(x)
\begin{enumerate}
\item Spoèítáme $h(x)$, natáhneme adresáø, nalezneme $d(S)$ a najdeme
stránky odpovídající prefixu $h(x)$ délky $d(S)$
\item Natáhneme odpovídající stránku do pamìti, zjistíme, zda obsahuje $x$ a
kdy¾ ano, provedeme po¾adovené úpravy.
\item Stránku ulo¾íme zpìt na stejné místo.
\end{enumerate}
\end{algorithm}

Operace ACCESS vy¾aduje 3 pøístupy na externí medium. (za pøedpokladu, ¾e
adresáø je také ulo¾en na externím mediu a zabírá jednu stránku) 

Pro rychlou implementaci aktualizaèních operací je vhodné mít u ka¾dé
stránky ulo¾eno informaci kolik je prvkù na stránce.


\subsection{Operace INSERT}

viz algoritmus \ref{alg:exthash.insert}

% pozn: \mnote nesmi byt uvnitr prostredi algorithm
\begin{algorithm}[!htb]
\caption{INSERT pro externí ha¹ování}
\label{alg:exthash.insert}
INSERT(x)
\begin{enumerate}
\item Spoèítáme $h(x)$, natáhneme adresáø, nalezneme $d(S)$ a nalezneme adresu
stránky odpovídající prefixu $h(x)$ délky $d(S)$. (XXX odkud vezmu $d(S)$ ?)
% XXX \mnote{$d(S)$ vezmu odkud ?}
\item Natáhneme do pamìti odpovídající stránku. kdy¾ v ní existuje $x$ 
$\rightarrow$ konec
\item Kdy¾ neobsahuje $x$ a má ménì prvkù ne¾ $b$, vlo¾íme $x$ do této stránky
a ulo¾íme ji zpátky na stejné místo a aktualizujeme adresáø (poèty prvkù
na stránce)
\item Kdy¾ stránka prvek $x$ neobsahuje a má $b$ prvkù, stránku rozdìlíme
(nalezneme nové $d(s)$ pro $s$ z této stránky i s pøidaným $x$), stránky 
ulo¾íme a aktualizujeme adresáø.
\end{enumerate}
\end{algorithm}
\mnote{pokud je novì nalezené $d(s) \leq d(S)$, adresáø se zvìt¹ovat nebude}

Operace INSERT vy¾aduje 6 pøístupù na externí medium.

\begin{pozn}
Roz¹tìpení stránky nemusí nutnì znamenat zvìt¹ení adresáøe.
\end{pozn}

\begin{priklad}
\label{priklad:exthash.insert2}
Do mno¾iny z pøíkladu \ref{priklad:exthash.tree} vlo¾íme pomocí operace
INSERT prvek 1111. Hodnota $d(1100) = 1$ se po vlo¾ení prvku 1111
nezmìní. Podstrom reprezentující prvky mno¾iny $S$ s prefixem 11
bude mít po vlo¾ení prvku 1111 dva syny. (viz obr.
\ref{fig.hash.extern.ins})

\begin{figure}[!htb]
\centering\includegraphics{pics/exthash-ins}
\caption{Podstrom reprezentující prvky mno¾iny $S$ s prefixem 11 po
vlo¾ení prvku 1111}
\label{fig.hash.extern.ins}
\end{figure}

Pokud vezmeme situaci danou po vlo¾ení prvku 1111, bude adresáø vypadat
takto:

\vspace{5mm}

\begin{tabular}{lll}
00 & $\rightarrow$ & 0000, 0001 \\
\hline
01 & $\rightarrow$ & 0100 \\
\hline
10 & $\searrow$ & 	 \\
  & &  1001 \\
11 & $\nearrow$	& \\
\end{tabular}

\vspace{5mm}

Nyní vlo¾íme prvek 0010. V tomto pøípadì dojde ke zvìt¹ení adresáøe:

\vspace{5mm}

\begin{tabular}{lll}
000 & $\rightarrow$ & 0000, 0001 \\
\hline
001 & $\rightarrow$ & 0010 \\
\hline
010 & $\rightarrow$ & 0100 \\
011 & $\nearrow$ & \\
\hline
100 & $\searrow$ & \\
101 & $\rightarrow$ &  1001, 1111 \\
110 & $\nearrow$ & \\
111 & $\nearrow$ & \\
\end{tabular}

\vspace{5mm}

Hodnota $d(S)$ je nyní 3.
\end{priklad}


\subsection{Operace DELETE}

viz algoritmus \ref{alg:exthash.delete}

\begin{algorithm}[!htb]
\caption{DELETE pro externí ha¹ování}
\label{alg:exthash.delete}
DELETE(x)
\begin{enumerate}
\item spoèítáme $h(x)$, natáhneme adresáø, nalezneme $d(S)$, nalezneme adresu
stránky odpovídající prefixu $h(x)$ délky $d(S)$, zjistíme zda po odebrání
prvku $x$ mù¾e nastat spojování stránek a pokud ano, nalezneme adresu
stránky, která se spojí s na¹í stránkou
\item natáhneme odpovídající stránku do pamìti, zjistíme zda obsahuje $x$,
pokud ne, tak konec
\item kdy¾ obsahuje $x$ a nemù¾e dojít ke slouèení stránek, tak odstraníme
$x$, stránku ulo¾íme na stejné místo a aktualizujeme adresáø (poèty prvkù na
stránce)
\item kdy¾ obsahuje a dojde ke sluèování, pak odstraníme $x$, natáhneme
druhou stránku a stránky slouèíme, ulo¾íme novou stránku a aktualizujeme
adresáø.
\end{enumerate}
\end{algorithm}
\mnote{pro aktualizaci adresáøe to mohou být 2 operace - naètení a
ulo¾ení. zøejmì proto, aby mohlo být souèasnì pu¹tìno víc operací.}

\begin{priklad}
Pro situaci z pøíkladu \ref{priklad:exthash.insert} provedeme
DELETE(0100). V adresáøi budou pak polo¾ky 010 a 011 ukazovat na prázdnou
stránku (NIL). Adresáø zùstal po této operaci stejný.

Nyní sma¾eme prvek 0001.

\begin{figure}[!htb]
\centering\includegraphics{pics/exthash-del}
\caption{Èást stromu reprezentujícího mno¾inu $S$ pøed smazáním prvku 0001}
\label{fig.hash.extern.del}
\end{figure}

Na obr. \ref{fig.hash.extern.del} je vidìt, ¾e po smazání prvku 
0001 mù¾e být adresáø opìt zmen¹en.

Po provedení DELETE(0001) bude adresáø vypadat takto:

\vspace{5mm}

\begin{tabular}{lll}
000 & $\rightarrow$ & 0000, 0010 \\
001 & $\nearrow$ & \\
\hline
010 & $\rightarrow$ & NIL \\
011 & $\nearrow$ & \\
\hline
100 & $\searrow$ & \\
101 & $\rightarrow$ &  1001, 1111 \\
110 & $\nearrow$ & \\
111 & $\nearrow$ & \\
\end{tabular}

\vspace{5mm}

Nyní mù¾eme provést zmen¹ení adresáøe na:

\vspace{5mm}

\begin{tabular}{lll}
00 & $\rightarrow$ & 0000, 0010 \\
01 & $\nearrow$ & \\
\hline
10 & $\rightarrow$ & 1100, 1111	 \\
11 & $\nearrow$	& \\
\end{tabular}

\vspace{5mm}

Tento adresáø mù¾eme je¹tì zmen¹it:

\vspace{5mm}

\begin{tabular}{lll}
0 & $\rightarrow$ & 0000, 0010 \\
\hline
1 & $\rightarrow$ & 1100, 1111 \\
\end{tabular}
\end{priklad}

\begin{pozn}
Pesimistický odhad pro operaci DELETE je nejvý¹e 6 pøístupù na externí 
medium.
\end{pozn}

\subsubsection{Aktualizace adresáøe}

V posledním kroku DELETE se provádí aktualizace adresáøe. 
Nejprve provedeme opravení odkazù na stránky: pokud u sudého záznamu v
adresáøi dojde k vyprázdnìní stránky, bude tam odkaz na NIL. pokud dojde k
vyprázdnìní u liché stránky, pøehodí se odkaz na pøedchozí (sudou)
stránku.

Potom se testuje, zda jde adresáø zmen¹it. Zmen¹ování provádíme tak
dlouho, dokud to jde.

\subsection{Reprezentace adresáøe}

\begin{itemize}
\item reprezentovat jako posloupnost dvojic (adresa stránky, poèet prvkù na
stránce), kde $i$-tá dvojice je pøiøazení $i$-tému slovu v lexikografickém
uspoøádání.
\item zvìt¹ování adresáøe znamená zdvojení prvkù
\item test na zmen¹ování adresáøe - testujeme, zda adresa na lichém místì
je stejná jako adresa na následujícím sudém místì - pokud ano, tak zmen¹ím
adresáø vymazáním sudých èlenù posloupnosti.
\end{itemize}

Oèekávané zaplnìní stránky pøi rovnomìrném rozlo¾ení dat je 
$b \ln 2 \approx 0.69 b$

Oèekávaná velikost adresáøe je $\frac{e}{b \ln 2} n^{1 + \frac{1}{b}}$ (pøi
rovnomìrném rozlo¾ení dat)

\begin{pozn}
Èlen $n^{1 + \frac{1}{b}}$ není lineární, zde je problém, proto se to
nehodí pro malá $b$.
\end{pozn}

\begin{tabular}{|l||l|l|l|l|}
\hline
b/n   	&$10^5$   &$10^6$ 	&$10^8$ 	&$10^{10}$    \\
\hline
2  	&$6.2*10^7$  &$1.96*10^8$	&$1.96*10^{11}$	&$1.96*10^{14}$ \\
10	&$1.2*10^5$  &$1.5*10^6$	&$2.4*10^8$	&$3.9*10^{10}$  \\
50	&$9.8*10^3$  &$1.0*10^6$	&$1.1*10^8$	&$1.2*10^{10}$  \\
100	&$4.4*10^3$  &$4.5*10^4$	&$4.7*10^6$	&$4.9*10^8$   \\
\hline
\end{tabular}

\vspace{5mm}

Jak je vidìt, pro $b = 2$ se to nehodí, adresáø je vìt¹í ne¾ velikost dat.

\begin{pozn}
Kdy¾ pracujeme s velikostí $S$ kolem $10^{10}$, pak je vhodné, aby 
$b \geq 100$. Pro vìt¹í mno¾iny $S$ musí být $b$ vìt¹í.
\end{pozn}

% --------------------------------------------------------------------------
\section{Perfektní ha¹ování}

Perfektním ha¹ováním myslíme úlohu nalézt pro danou pevnou mno¾inu 
$S \subseteq U, |S| = n$ perfektní ha¹ovací funkci, tj. funkci, která nemá na 
mno¾inì $S$ kolize. Tato úloha nepøipou¹tí pøirozenou implementaci 
operace INSERT, proto¾e pøidaný prvek mù¾e zpùsobit kolizi. 
Typický pøíklad pou¾ití je tabulka klíèových slov kompilátoru.

\begin{defn}
Funkce $h: U \to \intrange{0}{m-1}$ je perfektní pro $S$, kdy¾ je na S
prostá ($\forall x\neq y \in S$ platí $h(x) \neq h(y)$).
\end{defn}

Za jakých podmínek lze povolit INSERT? Musí být málo
pravdìpodobný. Prvky navíc se dávají jinam a po jisté dobì se v¹e
pøepoèítá do jedné tabulky pro novou perfektní ha¹ovací funkci.

Po¾adavky na hledanou ha¹ovací funkci:
\begin{enumerate}
\item $h$ je perfektní na $S$
\item $\forall x$ je $h(x)$ rychle spoèitatelná
\item $m$ øádovì srovnatelné s $n$
\item zakódování $h$ vy¾aduje málo prostoru
\end{enumerate}
Po¾adavky 2) a 3) jdou proti sobì. A a¾ se nám je podaøí skloubit,
budeme mít problémy s 4). A navíc hledání $h$ potrvá dlouho.

% ..........................................................................
\subsection{Perfektní ha¹ovací funkce do tabulky velikosti $n^2$}

Vyu¾ijeme, co u¾ víme o univerzálním ha¹ování. Pro $k \in \intrange{1}{N-1}$ 
a pro pevné $m$ definujme 
\begin{equation}
h_k(x) = ( kx \bmod N ) \bmod m, \quad\text{kde $N=|U|$ je prvoèíslo.}
\end{equation}
Budeme hledat vhodná $k$, $m$.
Definujme míru perfektnosti
\begin{equation}
d = \sum_{k=1}^{N-1} \sum_{x \neq y \in S} \delta_{h_k}(x,y)
\end{equation}
a pro $k \in \intrange{1}{N-1}$ polo¾me
\begin{equation}
b_k(i) = |\{ x \in S : h_k(x) = i \}|
\end{equation}

Jednak platí
\begin{align}
\label{bki2}
d & = \sum_{k=1}^{N-1} \left( \sum_{i=0}^{m-1} ( b_k(i) )^2 -n \right)\\
\intertext{a také}
d & = \sum_{x \neq y \in S} |\{ k : h_k(x)=h_k(y) \}|
	&&\text{prohozením sum}\\
\end{align}

Co znamená $h_k(x) = h_k(y)$ pro $x \neq y$? Následující tvrzení jsou
ekvivalentní:
\begin{align*}
kx \bmod N & = ky \bmod N && \pmod m\\
k(x-y) \bmod N & = 0 && \pmod m\\
k(x-y) \bmod N & = r m && \text{pro } r \in 
% *ceil -> *floor (fakticka poznamka od Ladislava Proska
	\{ - \lfloor N/m \rfloor .. \lfloor N/m \rfloor \} - \{0\}, \\
\end{align*}
tedy
\[
d \leq \sum_{x \neq y \in S} 2 \frac Nm = \frac{2 n(n-1) N}m
\]
a dosazením do \eqref{bki2}, podle pøihrádkového principu
\begin{equation}
\label{existsk}
\exists k : \sum_{i=0}^{m-1} ( b_k(i) )^2 \leq n + \frac{2 n(n-1)}m
\end{equation}

Pro speciální velikosti tabulky dostáváme dosazením do \eqref{existsk}:
\begin{align}
\label{3n}
&\text{Pro } m = n: 
&& \exists k \text{ nalezitelné v èase }O(nN): 
\sum_{i=0}^{m-1} ( b_k(i) )^2 < 3n\\
\label{perf}
&\text{Pro } m = 1 + n(n-1): 
&& \exists k \text{ nalezitelné v èase }O(nN):  
h_k \text{ je perfektní} 
\end{align}

\begin{proof}
Probíráme v¹echny mo¾nosti pro $k$, tìch je $O(N)$.
\begin{enumerate}
\item[\eqref{3n}]
Pro dané $k$ spoèítáme $\sum ( b_k(i) )^2$ v èase $O(n) = O(m)$.
\item[\eqref{perf}]
$\sum ( b_k(i) )^2 \leq n + \frac{2 n(n-1)}{1+ n(n-1)} < n + 2$.
Kdyby $h_k$ nebyla perfektní, pak 
$\exists j : b_k(j) \geq 2$
a
$\sum ( b_k(i) )^2 \geq (n-2) 1^2 + 1 \cdot 2^2 = n + 2$,
spor.
Pøi hledání $k$ ovìøíme perfektnost $h_k$ v èase $O(n)$.
% zmatek s indexy u k (T. Matousek):
% Tohle by melo byt vporadku. k je jako scitaci index jen v (4.8) a (4.10)
% a dal uz ne.
% Ten soucet v d jde pres vsechny hashovaci funkce a jedna z nich je ta
% prava. Ja bych to tak nechal, je to ok. Staci smazat tu *.
\end{enumerate}
\end{proof}

Nyní máme perfektní ha¹ovací funkci, která ale poru¹uje po¾adavek (3).
% ..........................................................................
\subsection{Perfektní ha¹ovací funkce do tabulky velikosti $3n$}

Zkombinujeme oba výsledky z pøedchozí èásti.
% --- nejprve první funkcí ha¹ujeme do tabulky velikosti $< 3n$

Podle \eqref{3n} nalezneme $k$ takové, ¾e
$\sum ( b_k(i) )^2 < 3n$.

Pro ka¾dé $i \in \intrange{0}{n-1}$ vezmeme mno¾inu kolidujících prvkù
$S_i = \{ s \in S : h_k(s) = i \}$.
Oznaème $n_i = |S_i|$.

Podle \eqref{perf} pro ka¾dé $i$ nalezneme $k_i$ takové, ¾e
pro $m_i = 1 + n_i(n_i-1)$ je $h_{k_i}$ perfektní pro $S_i$.

Ka¾dou zaha¹ovanou mno¾inu $S_i$ ulo¾íme ve výsledné tabulce od pozice
$d_i$: 
\[
d_i = \sum_{j=0}^{i-1}(1 + n_j(n_j-1)).
\]

Koneènì definujme
\[
g(x) = d_i + h_{k_i}(x),\quad\text{kde } i = h_k(x),
\]
která je perfektní a velikost tabulky je
\[
m = d_n = \sum_{j=0}^{n-1}(1 + n_j(n_j-1))
\leq \sum_{j=0}^{n-1} n_j^2
=  \sum_{j=0}^{n-1} (b_k(j))^2
< 3n
\]

Ov¹em na zakódování této funkce potøebujeme hodnì pamìti: 
nevadí nám $d_i$, 
ale $k$ a ka¾dé $k_i$ je velikosti $O(N)$, 
tedy potøebujeme $n \log_2 N$ bitù, co¾ odporuje na¹emu po¾adavku (4).
V dal¹ích krocích budeme zmen¹ovat èísla definující ha¹ovací funkci.
% ..........................................................................
\subsubsection{Podobná funkce daná èíslem velikosti $O(N)$}

\mnote{lep¹í jména promìnných!}
Zvolme prvoèíslo $p_1$ takové, ¾e 
$1 +n(n-1) \leq p_1 \leq 1+ 2n(n-1)$. Nìjaké takové musí existovat
(Bertrandùv postulát: $\forall n>1 \exists$ provèíslo p, ¾e 
$n < p < 2n$).
Podle \eqref{perf} %TODO, musíme dokázat m \geq, co¾ mírnì zatemní dk.
$\exists k : h_k(x) = ( kx \bmod N) \bmod p_1$ 
je perfektní na $S$.

Vytvoøme
\[
S_1 = \{ h_k(s) : s \in S\} \subset \intrange{0}{p_1 -1}
\]
a na $S_1$ aplikujme pøedchozí sekci, kde $N = p_1$.

Dostáváme ha¹ovací funkci $g_1$, která
\begin{itemize}
\item je perfektní pro $S$
\item je spoèitatelná v èase $O(1)$ 
\item ha¹uje do tabulky $<3n$ 
\item je urèena 1 èíslem velikosti $O(N)$ \\
 \quad a $O(n)$ èísly velikosti $O(n^2)$ 
\end{itemize}

% ..........................................................................
\subsubsection{Podobná funkce daná èíslem velikosti $O(n^2\log N)$}
Pro extrémní pøípady typu $N = 2^{10^6}$ je¹tì postup vylep¹íme,
èím¾ zmen¹íme velikost èísel kódujících perfektní ha¹ovací funkci 
na $O(\log N)$.

\begin{lemma}
\label{n2logN}
Pro ka¾dou mno¾inu $S \subseteq \intrange{0}{N-1}$ velikosti $n$ existuje
prvoèíslo $p$ takové, ¾e $f_{p}(x) = x \bmod p$ je perfektní na
$S$ a $p = O(n^2 \log N)$.
\end{lemma}

Vyu¾ití: pro $S$ najdeme prvoèíslo $p_0$ velikosti $O(n^2 \log N)$
takové, ¾e $f_{p_0}$ je perfektní na $S$. Vytvoøíme 
\[
S_0 = \{ f_{p_0}(s) : s \in S\} \subset \intrange{0}{p_0-1}
\]
a na $S_0$ aplikujme pøedchozí postup, kde $N = p_0$.

Tedy pro ka¾dou mno¾inu $S$ velikosti $n$ existuje ha¹ovací funkce $f$, která
\begin{itemize}
\item je perfektní pro $S$
\item je spoèitatelná v èase $O(1)$ 
\item ha¹uje do tabulky $<3n$ 
\item je urèena 2 èísly velikosti $O(n^2 \log N)$ \\
 \quad a $O(n)$ èísly velikosti $O(n^2)$ 
\end{itemize}

\begin{lemma}
\label{prvociselnidelitele}
Nech» $r$ je èíslo a $p_1, \ldots, p_q$ jsou v¹echny jeho prvoèíselné
dìlitele. Pak $q=O(\log r / \log\log r)$.
\end{lemma}
\begin{proof}
\begin{align*}
r & \geq \prod_{i=1}^q p_i\\
 & > q! \\
 & = \exp(\sum_{i=1}^q \ln i) \\
 & > \exp(\int_1^q \ln x \,dx) \\
 & \geq {\left( \frac qe \right)}^q \qquad\text{kde } \exp(x)=e^x
\end{align*}
Tedy
\mnote{skok}
\[
q \leq c \frac{\ln r}{\ln\ln r} \quad\text{pro vhodnou konstantu $c$.}
\]
\end{proof}
\begin{proof}[Dùkaz lemmatu \ref{n2logN}]
Pøedpokládejme $S = \{ x_1 < \ldots < x_n \}$.
Ha¹ovací funkce $f_t(x) = x \bmod t$ je perfektní právì kdy¾ $t$ je
nesoudìlné s èíslem
\[
D = \prod_{i>j} (x_i - x_j) < N^{n^2}
\]
Podle \ref{prvociselnidelitele} je mezi prvními $(c \ln D / \ln\ln D)+1$
prvoèísly alespoò jedno, které nedìlí $D$. Víme, ¾e $p_k = O(k \ln
k)$, tedy 
$(c \ln D / \ln\ln D) +1$-ní prvoèíslo má velikost
$O(\ln D) = O( n^2 \ln N)$.
\end{proof}
\mnote{nalezeni prvocisla $p_0$ vyzaduje cas $O(n^2\log N)$.}

% ..........................................................................
\subsection{GPERF}

Jiná konstrukce perfektní ha¹ovací funkce je pou¾ita v programu
{\tt gperf}. Distribuován pod GPL. 
Jeho návrh je popsán v \cite{douglas-GPERF}.


% --------------------------------------------------------------------------
\def\xx{% commented out
\section{Ha¹ování pro externí pamì»}

\mnote{Tohle u¾ Koubek nepøedná¹í} % - zrejme komentar od M.Vidnera
% - sice to Koubek neprednasi (prednasi se to v predmetu OZD), 
% ale u statnic se to zkousi
% Externi hashovani je popsano v jine sekci.
Adresáø.

MEMBER, INSERT, DELETE

Oèekávané zaplnìní stránky, poèet stránek, velikost adresáøe --- jen
citace, tabulka pro nìkterá èísla.
}% commented out
